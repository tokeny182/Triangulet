<!DOCTYPE html>
<html>

<head>
  <title>Chat | Triangulet</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css">
  <link rel="stylesheet" href="https://triangulet.glitch.me/style.css">
  <link rel="stylesheet" crossorigin="anonymous" href="https://ac.blooket.com/dashclassic/assets/index-BQ9cjwWZ.css">
  <link rel="icon" type="image/x-icon" href="https://i.ibb.co/5GBHSTB/Triangulet-Game-Logo.png">

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #222;
      color: #fff;
    }

    #chat-container {
      height: 502px;
      width: 80%;
      max-width: 1114px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
      background-color: rgba(0, 0, 0, 0);
      margin-left: 220px;
    }

    .chat-message {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      color: #fff;
    }


    .styles__infoContainer___2uI-S-camelCase {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 1000px;
  padding: 12px;
  position: fixed;
  bottom: 0;
  left: 25%;
  transform: translateX(-10%);
}

.styles__infoContainer___2uI-S-camelCase i.fa-plus {
  color: #fff;
  font-size: 20px;
  cursor: pointer;
  flex-shrink: 0;
   margin-bottom: -35px;
  transform: translateX(-2800%);
}

    input[type="text"] {
      width: 95%;
      padding: 5px;
      font-size: 16px;
      font-family: 'Nunito', sans-serif;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      border: none;
      outline: none;
      border-radius: 5px;
      display: inline-block;
      transform: translateX(1%);
    }
  </style>
</head>

<body>
<div class="styles__background___2J-JA-camelCase">
  <div class="styles__blooksBackground___3oQ7Y-camelCase" style="background-image: url('https://i.ibb.co/d7GK1cC/background.png'); animation: animatedBackground 9s linear infinite;"></div>
</div>

<div class="styles__topRightRow___dQvxc-camelCase">
  <div class="styles__profileContainer___CSuIE-camelCase" role="button" tabindex="0">
    <div class="styles__profileRow___cJa4E-camelCase">
      <div style="position: relative" class="styles__blookContainer___36LK2-camelCase styles__profileBlook___37mfP-camelCase">
        <img src="https://i.ibb.co/r2gYyjdJ/output-onlinepngtools-3.png" id="status" draggable="false" class="styles__blook___1R6So-camelCase">
      </div>
      <span style="color: #ffffff" id="usersnamedrop">0 Users Online</span>
    </div>

    <i class="fas fa-angle-down styles__profileDropdownIcon___3iLIX-camelCase" aria-hidden="true"></i>

    <div class="styles__profileDropdownMenu___2jUAA-camelCase" id="online-users-dropdown" style="max-height: 300px; overflow-y: auto;">

    </div>
  </div>

  <div class="styles__profileContainer___CSuIE-camelCase" role="button" tabindex="0">
    <div class="styles__profileRow___cJa4E-camelCase">
      <div style="position: relative" class="styles__blookContainer___36LK2-camelCase styles__profileBlook___37mfP-camelCase">
        <img src="https://i.ibb.co/5GBHSTB/Triangulet-Game-Logo.png" id="pfpimg" draggable="false" class="styles__blook___1R6So-camelCase">
      </div>
      <span style="color: #ffffff" id="usernamedrop">user</span>
    </div>
    <i class="fas fa-angle-down styles__profileDropdownIcon___3iLIX-camelCase" aria-hidden="true"></i>
    <div class="styles__profileDropdownMenu___2jUAA-camelCase">
      <a id="logout-link" class="styles__profileDropdownOption___ljZXD-camelCase" href="/login">
  <i class="fas fa-sign-out-alt styles__profileDropdownOptionIcon___15VKX-camelCase" aria-hidden="true"></i>
  Logout
</a>
    </div>
  </div>
</div>

  <div class="styles__sidebar___1XqWi-camelCase">
    <a href="/" id="big-name" class="styles__blooketText___1pMBG-camelCase">Triangulet</a>
    <a class="_button_552gk_1 _bigButton_l4eyq_22" href="/play">
    <div class="_shadow_552gk_11"></div>
    <div class="_edge_552gk_23" style="background-color: #4a7233"></div>
    <div class="_front_552gk_33" style="background-color: #53b721">
        <div class="_bigButtonInside_l4eyq_26"><i class="fas fa-play _bigIcon_l4eyq_39"></i>Play</div>
    </div>
</a>
      <div class="nothin">
        <a class="styles__pageButton___1wFuu-camelCase" href="/market">
          <i class="styles__pageIcon___3OSy9-camelCase fas fa-store" aria-hidden="true"></i>
          <div class="styles__pageText___1eo7q-camelCase">Market</div>
        </a>
        <a class="styles__pageButton___1wFuu-camelCase" href="/trians">
          <i class="styles__pageIcon___3OSy9-camelCase fas fa-suitcase" aria-hidden="true"></i>
          <div class="styles__pageText___1eo7q-camelCase">Trians</div>
        </a>
        <a class="styles__pageButton___1wFuu-camelCase" href="/leaderboard">
          <i class="styles__pageIcon___3OSy9-camelCase fas fa-trophy" aria-hidden="true"></i>
          <div class="styles__pageText___1eo7q-camelCase">Leaderboard</div>
        </a>
        <a class="styles__pageButton___1wFuu-camelCase" href="/chat">
          <i class="styles__pageIcon___3OSy9-camelCase fas fa-comment" aria-hidden="true"></i>
          <div class="styles__pageText___1eo7q-camelCase">Chat</div>
        </a>
        <a class="styles__pageButton___1wFuu-camelCase" href="/posts">
          <i class="styles__pageIcon___3OSy9-camelCase fas fa-file" aria-hidden="true"></i>
          <div class="styles__pageText___1eo7q-camelCase">Posts</div>
        </a>
        <a class="styles__pageButton___1wFuu-camelCase" id="newsbutton" style="cursor: pointer;">
          <i class="styles__pageIcon___3OSy9-camelCase fas fa-newspaper" aria-hidden="true"></i>
          <div class="styles__pageText___1eo7q-camelCase">News</div>
        </a>
        <a class="styles__pageButton___1wFuu-camelCase" href="/auction">
          <i class="styles__pageIcon___3OSy9-camelCase fas fa-building-columns" aria-hidden="true"></i>
          <div class="styles__pageText___1eo7q-camelCase">Auction</div>
          <a class="styles__pageButton___1wFuu-camelCase" href="/trianai"><i class="styles__pageIcon___3OSy9-camelCase fas fa-robot" aria-hidden="true"></i>
            <div class="styles__pageText___1eo7q-camelCase">TrianAI</div>
          </a>
        </a>
        <a class="styles__pageButton___1wFuu-camelCase" href="/staff">
          <i class="styles__pageIcon___3OSy9-camelCase fas fa-terminal" aria-hidden="true"></i>
          <div class="styles__pageText___1eo7q-camelCase">Staff</div>
        </a>
      </div>
    <div class="styles__bottomRow___3OozA-camelCase">
      <a data-tip="Credits" class="styles__smallButton___sQuq8-camelCase" href="/credits" currentitem="false"><i class="styles__bottomIcon___3Fswk-camelCase fas fa-address-book" aria-hidden="true"></i></a>
      <a data-tip="Settings" class="styles__smallButton___sQuq8-camelCase" href="/settings" currentitem="false"><i class="styles__bottomIcon___3Fswk-camelCase fas fa-cogs" aria-hidden="true"></i></a>
      <a data-tip="Stats" class="styles__smallButton___sQuq8-camelCase" href="/stats" currentitem="false"><i class="styles__bottomIcon___3Fswk-camelCase fas fa-user" aria-hidden="true"></i></a>
      <a data-tip="Stats" class="styles__smallButton___sQuq8-camelCase" href="https://discord.gg/FcYy4uHUws" currentitem="false"><i class="styles__bottomIcon___3Fswk-camelCase fab fa-discord" aria-hidden="true"></i></a>
    </div>
  </div>
<div id="chat-container"></div>

<div id="typing-indicator" style="margin: -5px 0 10px 220px; padding-left: 20px; font-style: italic; color: #ffff; font-size: 14px;"></div>
<div id="new-message" style="display:none; margin: -12px 0 10px 220px; padding-left: 400px; font-weight: bold; color: #fff; font-size: 18px; cursor: pointer;"></div>


<div class="styles__infoContainer___2uI-S-camelCase">
  <i class="fa-solid fa-plus" style="cursor: pointer;" onclick="document.getElementById('fileInput').click();"></i>
<input type="file" id="fileInput" accept="image/*,video/*,audio/*" style="display: none;">  
  <input type="text" id="user-input" placeholder="Type a message..." maxlength="160" />
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getDatabase, ref, push, onChildAdded, set, remove,
  onValue, query, orderByChild, limitToLast, endAt, onDisconnect
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDV9tQXgzqxUayhvc384tTLOwy0QOEZVcU",
  authDomain: "chat-e6c93.firebaseapp.com",
  databaseURL: "https://chat-e6c93-default-rtdb.firebaseio.com",
  projectId: "chat-e6c93",
  storageBucket: "chat-e6c93.appspot.com",
  messagingSenderId: "131547791719",
  appId: "1:131547791719:web:2f567033f028810345afc2",
  measurementId: "G-VY49LNJJLG"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const chatRef = ref(db, 'triangulet1/');
const typingRef = ref(db, 'triangulet_typing/');
const onlineRef = ref(db, 'triangulet_online/');

const PAGE_SIZE = 20;
let earliestTimestamp = null;
let loadingOlderMessages = false;
let loadedMessages = new Set();
let firstLoadDone = false;

document.addEventListener('DOMContentLoaded', () => {
  const currentUser = localStorage.getItem("triangulet_username") || "User";
  const userKey = currentUser.replace(/\W+/g, "_");
  const userStatusRef = ref(db, `triangulet_online/${userKey}`);
  setInterval(() => {
    set(userStatusRef, { username: currentUser, timestamp: Date.now() });
  }, 1000);
  onDisconnect(userStatusRef).remove();

  const usersNameDrop = document.getElementById("usersnamedrop");
  const usersDropdown = document.getElementById("online-users-dropdown");

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.innerText = text;
    return div.innerHTML;
  }

  function updateUserListDisplay(userList) {
    usersDropdown.innerHTML = "";

    userList.forEach(user => {
      const safeUser = escapeHtml(user);
      const displayName = safeUser.length > 15
        ? escapeHtml(safeUser.slice(0, 15)) + "..."
        : safeUser;

      const item = document.createElement("a");
      item.className = "styles__profileDropdownOption___ljZXD-camelCase";
      item.innerHTML = `
        <i class="fas fa-user styles__profileDropdownOptionIcon___15VKX-camelCase"></i>
        <span title="${safeUser}">${displayName}</span>
      `;
      usersDropdown.appendChild(item);
    });

    usersNameDrop.textContent = `${userList.length} User${userList.length !== 1 ? 's' : ''} Online`;
    usersDropdown.style.maxHeight = userList.length > 15 ? "300px" : "unset";
    usersDropdown.style.overflowY = userList.length > 15 ? "auto" : "unset";
  }

  onValue(onlineRef, snapshot => {
    const data = snapshot.val() || {};
    const users = Object.values(data).map(entry => entry.username).filter(Boolean).sort((a, b) => a.localeCompare(b));
    updateUserListDisplay(users);
  });

  const chatContainer = document.getElementById("chat-container");
  const userInput = document.getElementById("user-input");
  const typingIndicator = document.getElementById("typing-indicator");
  const newMessageBanner = document.getElementById("new-message");
  const username = escapeHtml(currentUser);
  let newMessageCount = 0;

  function formatTimestamp(iso) {
    const date = new Date(iso);
    const now = new Date();
    const yesterday = new Date();
    yesterday.setDate(now.getDate() - 1);
    const options = { hour: 'numeric', minute: '2-digit', hour12: true };

    if (date.toDateString() === now.toDateString())
      return date.toLocaleTimeString(undefined, options);
    if (date.toDateString() === yesterday.toDateString())
      return `Yesterday at ${date.toLocaleTimeString(undefined, options)}`;
    return date.toLocaleString(undefined, { year: '2-digit', month: 'numeric', day: 'numeric', ...options });
  }

 function renderMessage(text) {
  const blockedDomains = [
    "iplogger","wl.gl","ed.tc","bc.ax","maper.info","2no.co","yip.su",
    "iplis.ru","ezstat.ru","iplog.co","iplogger.cn","grabify","hd.gd",
    "onbit.pro","snifferip.com","unl.one","urlto.me","location.cyou",
    "mymap.icu","mymap.quest","map-s.online","crypto-o.click","cryp-o.online",
    "account.beauty","photospace.life","photovault.store","imagehub.fun",
    "sharevault.cloud","xtube.chat","screensnaps.top","photovault.pics",
    "foot.wiki","gamergirl.pro","picshost.pics","pichost.pics","imghost.pics",
    "screenshare.pics","myprivate.pics","shrekis.life","screenshot.best",
    "gamingfun.me","stopify.co"
  ];

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.innerText = text;
    return div.innerHTML;
  }

  function isBlockedUrl(url) {
    try {
      const lowered = url.toLowerCase();
      return blockedDomains.some(domain => lowered.includes(domain));
    } catch {
      return false;
    }
  }

  const trimmedText = text.trim();

  const containsHtmlTags = /<\/?[a-z][\s\S]*>/i.test(trimmedText);

  if (trimmedText.startsWith("data:")) {
    const mime = trimmedText.slice(5, trimmedText.indexOf(";"));
    if (mime.startsWith("image/")) {
      return `<img src="${trimmedText}" style="max-width: 300px; max-height: 300px; border-radius: 6px;">`;
    } else if (mime.startsWith("video/")) {
      return `<video controls style="max-width: 300px; max-height: 300px;">
                <source src="${trimmedText}" type="${mime}">
                Your browser does not support the video tag.
              </video>`;
    } else if (mime.startsWith("audio/")) {
      return `<audio controls>
                <source src="${trimmedText}" type="${mime}">
                Your browser does not support the audio tag.
              </audio>`;
    }
  }

  const urlRegex = /^https?:\/\/[^\s]+$/i;
  const imageUrlPattern = /(https?:\/\/.*\.(?:jpeg|jpg|gif|png|svg|webp|tiff|eps|bmp|avif|xcf|ico))/i;
  const videoUrlPattern = /(https?:\/\/.*\.(?:avi|mov|mp4|ogg|wmv|mkv|mpg|flv|avchd|mpeg4|m2ts|webm))/i;
  const audioUrlPattern = /(https?:\/\/.*\.(?:mp3|wav|aac|pcm|m4a|m4p|opus|flac|dsd|gsm|wma|ogg))/i;

  if (urlRegex.test(trimmedText)) {
    if (isBlockedUrl(trimmedText)) {
      return escapeHtml(trimmedText);
    }

    if (imageUrlPattern.test(trimmedText)) {
      return `<img src="${trimmedText}" style="max-width: 300px; max-height: 300px; border-radius: 6px;">`;
    } else if (videoUrlPattern.test(trimmedText)) {
      return `<video controls style="max-width: 300px; max-height: 300px;">
                <source src="${trimmedText}">
                Your browser does not support the video tag.
              </video>`;
    } else if (audioUrlPattern.test(trimmedText)) {
      return `<audio controls>
                <source src="${trimmedText}">
                Your browser does not support the audio tag.
              </audio>`;
    } else {

      return `<a href="${escapeHtml(trimmedText)}" target="_blank" rel="noopener noreferrer">${escapeHtml(trimmedText)}</a>`;
    }
  }

  if (containsHtmlTags) {
    return trimmedText;
  }

  return escapeHtml(text);
}



  function appendMessage(sender, text, timestamp, prepend = false) {
    const safeSender = escapeHtml(sender.length > 15 ? sender.slice(0, 15) + "..." : sender);
    const currentUser = escapeHtml(localStorage.getItem("triangulet_username") || "User");
    const mentionRegex = /@(\w{1,30})/g;
    const pingSound = new Audio("https://cdn.glitch.global/a6695a81-c90d-4020-ae20-474929cf2986/Blacket%20Reply%20SFX%20(mp3cut.net)%20(1).mp3?v=1749595919054");
    let containsMention = false;

    const processedText = escapeHtml(text).replace(mentionRegex, (_, m) => {
      const safe = escapeHtml(m);
      if (safe.toLowerCase() === currentUser.toLowerCase() || safe.toLowerCase() === "everyone")
        containsMention = true;
      return `<span style="color: blue; font-weight: bold;">@${safe}</span>`;
    });

    if (containsMention) pingSound.play().catch(() => {});

    const theme = localStorage.getItem("theme");
    const userIcon = theme === "Purple"
      ? "https://i.ibb.co/Qvz5nfbX/Triangulet-Game-Logo-Purple.png"
      : "https://i.ibb.co/5GBHSTB/Triangulet-Game-Logo.png";

    const msgStyle = containsMention
      ? "background-color: yellow; padding: 5px; border-radius: 4px; color: black;"
      : "color: white;";

    const formattedTime = formatTimestamp(timestamp);
    const html = `
      <div class="chat-message" style="display: flex; align-items: flex-start; margin-bottom: 15px; gap: 10px;">
        <img src="${userIcon}" alt="User Icon" style="width: 50px; height: 50px; border-radius: 0;">
        <div>
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
            <strong style="font-size: 1.2em; color: white;">${safeSender}</strong>
            <span style="font-size: 0.85em; color: white;">${formattedTime}</span>
          </div>
          <span style="font-size: 1em; word-break: break-word; ${msgStyle}">
            ${renderMessage(processedText)}
          </span>
        </div>
      </div>`;

    if (prepend) {
      const prevScroll = chatContainer.scrollHeight;
      chatContainer.insertAdjacentHTML('afterbegin', html);
      const diff = chatContainer.scrollHeight - prevScroll;
      chatContainer.scrollTop += diff;
    } else {
      chatContainer.insertAdjacentHTML('beforeend', html);
      if (isNearBottom()) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
        newMessageCount = 0;
        newMessageBanner.style.display = "none";
      } else {
        newMessageCount++;
        newMessageBanner.textContent = newMessageCount > 25 ? "25+ new messages" : `${newMessageCount} new message${newMessageCount > 1 ? "s" : ""}`;
        newMessageBanner.style.display = "block";
      }
    }
  }

  function isNearBottom() {
    return Math.abs(chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight) < 100;
  }

  async function loadMessages(initial = false) {
    if (loadingOlderMessages) return;
    loadingOlderMessages = true;

    let q;
    if (initial) {
      q = query(chatRef, orderByChild("timestamp"), limitToLast(PAGE_SIZE));
    } else if (earliestTimestamp) {
      q = query(chatRef, orderByChild("timestamp"), endAt(earliestTimestamp), limitToLast(PAGE_SIZE + 1));
    } else {
      loadingOlderMessages = false;
      return;
    }

    try {
      const snapshot = await new Promise(resolve => onValue(q, resolve, { onlyOnce: true }));
      const data = snapshot.val();
      if (!data) return;

      let messages = Object.entries(data).map(([id, msg]) => ({ id, ...msg }));
      messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      if (!initial) messages.pop();

      for (const msg of messages) {
        if (!loadedMessages.has(msg.id)) {
          appendMessage(msg.username || "User", msg.text, msg.timestamp, !initial);
          loadedMessages.add(msg.id);
          if (!earliestTimestamp || new Date(msg.timestamp) < new Date(earliestTimestamp))
            earliestTimestamp = msg.timestamp;
        }
      }

      if (initial) {
                setTimeout(() => {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 0);
                firstLoadDone = true;
                if (messages.length > 0) {
                    earliestTimestamp = messages[0].timestamp;
                }
            }

    } finally {
      loadingOlderMessages = false;
    }
  }

  onChildAdded(chatRef, (snapshot) => {
    const msg = snapshot.val();
    const id = snapshot.key;
    if (!loadedMessages.has(id) && firstLoadDone) {
      appendMessage(msg.username || "User", msg.text, msg.timestamp);
      loadedMessages.add(id);
    }
  });

  chatContainer.addEventListener("scroll", () => {
    if (chatContainer.scrollTop < 100 && !loadingOlderMessages) loadMessages(false);
    if (isNearBottom()) {
      newMessageCount = 0;
      newMessageBanner.style.display = "none";
    }
  });

  newMessageBanner.addEventListener("click", () => {
    chatContainer.scrollTop = chatContainer.scrollHeight;
    newMessageCount = 0;
    newMessageBanner.style.display = "none";
  });

  let typingTimeout;
  userInput.addEventListener("input", () => {
    pushTypingStatus(username);
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => removeTypingStatus(username), 3000);
  });

  function pushTypingStatus(name) {
    const key = name.replace(/\W+/g, "_");
    set(ref(db, `triangulet_typing/${key}`), { username: name, timestamp: Date.now() });
  }

  function removeTypingStatus(name) {
    const key = name.replace(/\W+/g, "_");
    remove(ref(db, `triangulet_typing/${key}`));
  }

  onValue(typingRef, (snapshot) => {
    const currentUser = (localStorage.getItem("triangulet_username") || "User").trim().toLowerCase();
    const data = snapshot.val() || {};
    const typers = Object.values(data).filter(entry => entry.username && entry.username.trim().toLowerCase() !== currentUser).map(entry => escapeHtml(entry.username));

    if (typers.length === 0) {
      typingIndicator.textContent = "";
    } else if (typers.length === 1) {
      typingIndicator.textContent = `${typers[0]} is typing...`;
    } else {
      const displayed = typers.slice(0, 2).join(", ");
      const remaining = typers.length - 2;
      typingIndicator.textContent = remaining > 0
        ? `${displayed}, and ${remaining} more are typing...`
        : `${displayed} are typing...`;
    }
  });

  userInput.addEventListener("keypress", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  async function sendMessage() {
    const text = userInput.value.trim();
    if (!text) return;
    const message = {
      text,
      username,
      timestamp: new Date().toISOString()
    };
    try {
      await push(chatRef, message);
      userInput.value = '';
      removeTypingStatus(username);
    } catch (err) {
      console.error("Send failed:", err);
    }
  }

  const fileInput = document.getElementById("fileInput");
  fileInput.addEventListener("change", async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
      const base64 = e.target.result;
      const message = {
        text: base64,
        username,
        timestamp: new Date().toISOString()
      };
      try {
        await push(chatRef, message);
      } catch (err) {
        console.error("Error sending base64 message:", err);
      }
    };

    reader.readAsDataURL(file);
  });

  loadMessages(true);
});
</script>







<script src="/news.js"></script> 
  <script src="/themes.js"></script>
  <script src="/all.js"></script>
</body>

</html> 
